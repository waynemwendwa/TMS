generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  role      UserRole
  passwordHash String?
  phone     String?
  poBox     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  inventoryLogs   InventoryLog[]
  createdProjects Project[]
  uploadedDocuments ProjectDocument[]
  createdBoqTemplates BoqTemplate[]
  createdOrderTemplates OrderTemplate[]
  supervisorAssignments SiteSupervisorAssignment[]
  
  // Order workflow relations
  requestedOrders        Order[] @relation("RequestedBy")
  procurementApprovedOrders Order[] @relation("ProcurementApprover")
  chairmanApprovedOrders    Order[] @relation("ChairmanApprover")
  procurementSourcedOrders  Order[] @relation("ProcurementSourcer")

  @@map("users")
}

enum UserRole {
  SITE_SUPERVISOR
  PROCUREMENT
  SUPPLIER
  CHAIRMAN
  CHAIRMAN_PA
  FINANCE_PROCUREMENT
}

// Inventory Management
model Inventory {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String
  location    String?
  minStock    Int      @default(0)
  maxStock    Int?
  currentStock Int     @default(0)
  unit        String
  unitPrice   Decimal? @db.Decimal(15, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  logs        InventoryLog[]
  orders      Order[]

  @@map("inventory")
}

model InventoryLog {
  id          String   @id @default(cuid())
  type        InventoryLogType
  quantity    Int
  previousStock Int
  newStock    Int
  remarks     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  userId      String
  user        User @relation(fields: [userId], references: [id])

  @@map("inventory_logs")
}

enum InventoryLogType {
  IN
  OUT
  ADJUSTMENT
  TRANSFER
}

// Office Documents Management
model OfficeDocument {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    DocumentCategory
  type        DocumentType
  size        Int
  url         String
  filePath    String
  uploadedBy  String
  uploadedAt  DateTime @default(now())
  tags        String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("office_documents")
}

enum DocumentCategory {
  CONTRACTS
  REPORTS
  POLICIES
  PROCEDURES
  TEMPLATES
  PROJECT_DOCUMENTS
  BOQ_DOCUMENTS
  OTHER
}

enum DocumentType {
  PDF
  DOC
  DOCX
  JPG
  JPEG
  PNG
}

// Project Management
model Project {
  id          String        @id @default(cuid())
  title       String
  description String?
  status      ProjectStatus @default(TO_START)
  startDate   DateTime?
  endDate     DateTime?
  estimatedDuration Int?    // in weeks
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   String

  // Relations
  documents          ProjectDocument[]
  stakeholders       ProjectStakeholder[]
  procurementItems   ProcurementItem[]
  projectPhases      ProjectPhase[]
  boqTemplates       BoqTemplate[]
  orderTemplates     OrderTemplate[]
  supervisorAssignments SiteSupervisorAssignment[]
  createdByUser      User @relation(fields: [createdBy], references: [id])
  orders             Order[]

  @@map("projects")
}

enum ProjectStatus {
  TO_START
  ONGOING
  COMPLETED
}

model ProjectDocument {
  id          String          @id @default(cuid())
  projectId   String
  name        String
  description String?
  category    ProjectDocumentCategory
  type        DocumentType
  size        Int
  url         String
  filePath    String
  uploadedBy  String
  uploadedAt  DateTime        @default(now())
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  documentType String         // "preliminary" or "boq"

  // Relations
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedByUser User @relation(fields: [uploadedBy], references: [id])

  @@map("project_documents")
}

enum ProjectDocumentCategory {
  LETTER_OF_AWARD
  ACCEPTANCE_OF_AWARD
  PERFORMANCE_BOND
  CONTRACT_SIGNING
  BOQ_DOCUMENT
  SAMPLE_APPROVAL
  OTHER
}

model ProjectStakeholder {
  id          String      @id @default(cuid())
  projectId   String
  name        String
  email       String?
  phone       String?
  location    String?
  role        StakeholderRole
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_stakeholders")
}

enum StakeholderRole {
  MAIN_CONTRACTOR
  CLIENT
  CONSULTANT
  STRUCTURAL_ENGINEER
  ARCHITECT
  QUANTITY_SURVEYOR
  SUB_CONTRACTOR
  LAW_FIRM
}

model ProcurementItem {
  id          String   @id @default(cuid())
  projectId   String
  itemName    String
  description String?
  quantity    Int
  unit        String
  estimatedCost Decimal? @db.Decimal(15, 2)
  supplierId  String?
  actualCost  Decimal? @db.Decimal(15, 2)
  status      ProcurementStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("procurement_items")
}

enum ProcurementStatus {
  PENDING
  QUOTED
  APPROVED
  ORDERED
  DELIVERED
}

model ProjectPhase {
  id          String   @id @default(cuid())
  projectId   String
  phaseName   String
  description String?
  startDate   DateTime?
  endDate     DateTime?
  status      PhaseStatus @default(PLANNED)
  weekNumber  Int
  tasks       String[] @default([])
  materials   String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_phases")
}

enum PhaseStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  DELAYED
}

// BOQ Template Management
model BoqTemplate {
  id          String   @id @default(cuid())
  projectId   String
  title       String   // Project title with phase
  equipmentInstallationWorks String // Materials needed to be installed
  billNumber  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String

  // Relations
  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdByUser User @relation(fields: [createdBy], references: [id])
  items       BoqTemplateItem[]

  @@map("boq_templates")
}

model BoqTemplateItem {
  id          String   @id @default(cuid())
  boqTemplateId String
  item        String
  description String?
  quantity    Int
  unit        String
  rate        Decimal  @db.Decimal(15, 2)
  amount      Decimal  @db.Decimal(15, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  boqTemplate BoqTemplate @relation(fields: [boqTemplateId], references: [id], onDelete: Cascade)

  @@map("boq_template_items")
}

// Site Supervisor Assignment (limits supervisors to specific projects)
model SiteSupervisorAssignment {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  createdAt DateTime @default(now())

  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@map("site_supervisor_assignments")
}

// Order Template Management (for site supervisors)
model OrderTemplate {
  id          String   @id @default(cuid())
  projectId   String
  title       String
  description String?
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdByUser User  @relation(fields: [createdBy], references: [id])
  items       OrderTemplateItem[]

  @@map("order_templates")
}

model OrderTemplateItem {
  id              String   @id @default(cuid())
  orderTemplateId String
  item            String
  description     String?
  quantity        Int
  unit            String
  rate            Decimal  @db.Decimal(15, 2)
  amount          Decimal  @db.Decimal(15, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  orderTemplate   OrderTemplate @relation(fields: [orderTemplateId], references: [id], onDelete: Cascade)

  @@map("order_template_items")
}

// Order Management with Approval Workflow
model Order {
  id            String      @id @default(cuid())
  orderNumber   String      @unique
  title         String
  description   String?
  status        OrderStatus @default(PENDING_PROCUREMENT)
  orderDate     DateTime    @default(now())
  requiredDate  DateTime?
  totalAmount   Decimal?    @db.Decimal(15, 2)
  remarks       String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  projectId     String
  requestedById String
  inventoryId   String?

  // Approval workflow fields
  procurementApprovedAt DateTime?
  procurementApprovedBy String?
  chairmanApprovedAt    DateTime?
  chairmanApprovedBy    String?
  procurementSourcedAt  DateTime?
  procurementSourcedBy  String?

  // Relations
  project           Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  requestedBy       User        @relation("RequestedBy", fields: [requestedById], references: [id])
  inventory         Inventory?  @relation(fields: [inventoryId], references: [id])
  procurementApprover User?     @relation("ProcurementApprover", fields: [procurementApprovedBy], references: [id])
  chairmanApprover    User?     @relation("ChairmanApprover", fields: [chairmanApprovedBy], references: [id])
  procurementSourcer  User?     @relation("ProcurementSourcer", fields: [procurementSourcedBy], references: [id])
  items             OrderItem[]
  deliveries        Delivery[]

  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  itemCode    String
  description String
  unit        String
  quantity    Int
  unitPrice   Decimal? @db.Decimal(15, 2)
  totalPrice  Decimal? @db.Decimal(15, 2)
  remarks     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  orderId     String

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model Delivery {
  id              String         @id @default(cuid())
  deliveryNumber  String         @unique
  orderId         String
  supplierId      String
  deliveryDate    DateTime       @default(now())
  receivedDate    DateTime?
  status          DeliveryStatus @default(PENDING)
  remarks         String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  order     Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  supplier  Supplier         @relation(fields: [supplierId], references: [id])
  documents DeliveryDocument[]

  @@map("deliveries")
}

model DeliveryDocument {
  id          String   @id @default(cuid())
  deliveryId  String
  name        String
  type        String
  size        Int
  url         String
  filePath    String
  uploadedAt  DateTime @default(now())

  // Relations
  delivery Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@map("delivery_documents")
}

model Supplier {
  id          String   @id @default(cuid())
  name        String
  email       String?
  phone       String?
  address     String?
  contactPerson String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  deliveries Delivery[]
  quotes     Quote[]

  @@map("suppliers")
}

model Quote {
  id          String      @id @default(cuid())
  quoteNumber String      @unique
  title       String
  description String?
  totalAmount Decimal     @db.Decimal(15, 2)
  validUntil  DateTime
  status      QuoteStatus @default(DRAFT)
  submittedAt DateTime    @default(now())
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  supplierId  String

  // Relations
  supplier Supplier      @relation(fields: [supplierId], references: [id])
  items    QuoteItem[]

  @@map("quotes")
}

model QuoteItem {
  id          String   @id @default(cuid())
  itemCode    String
  description String
  unit        String
  quantity    Int
  unitPrice   Decimal  @db.Decimal(15, 2)
  totalPrice  Decimal  @db.Decimal(15, 2)
  remarks     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  quoteId     String

  // Relations
  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@map("quote_items")
}

// Enums for Order Management
enum OrderStatus {
  PENDING_PROCUREMENT    // Order created by supervisor, waiting for procurement
  PENDING_CHAIRMAN       // Procurement reviewed, waiting for chairman approval
  APPROVED               // Chairman approved, ready for procurement to source
  REJECTED               // Rejected by chairman
  SOURCING               // Procurement is sourcing materials
  SOURCED                // Materials sourced, ready for delivery
  IN_PROGRESS            // Order in progress
  COMPLETED              // Order completed
  CANCELLED              // Order cancelled
}

enum DeliveryStatus {
  PENDING
  IN_TRANSIT
  DELIVERED
  RECEIVED
  VERIFIED
}

enum QuoteStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  EXPIRED
}
